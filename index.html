<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>MTGカード名to詳細</title>
<link rel="Stylesheet" href="./lib/main.css" type="text/css">
<script src="./lib/vue.min.js"></script>
</head>
<body>

<div id="vue_app">

<h1>MTGカード名to詳細</h1>

<div style="display:flex">
  <div id="input_area">
    
    <h2>追加カード入力</h2>
    <textarea style="width:30em; height:5em;" v-model="searchTarget"></textarea><br>
    <button id="btnAdd" @click="search()" :disabled="progress">{{ progress ?? "検索" }}</button>
    
    <h2>候補表示エリア</h2>
    <div v-for="kouhoGrp in kouhoGrpList">
      <h3 @click="delKouhoGrp(kouhoGrp)">{{ kouhoGrp.base }}</h3>
      <ul>
        <li v-for="kouho in kouhoGrp.list" @click="selKouho(kouhoGrp, kouho)" @mouseover="cardInfoHtml = kouho.html;">{{ kouho.name }}</li>
      </ul>
    </div>
    
    <h2>一覧</h2>
    <save-slot v-model="deck"></save-slot>
    <div>合計: {{ deckAllNum }} 枚</div>
    <table border=1>
      <tr>
        <th>&nbsp;<!-- DEL Button --></th>
        <th>枚数</th>
        <th v-for="col in cols" @click="sort(col.name)">{{ col.disp }}</th>
      </tr>
      <tr v-for="card in deck">
        <td><button @click="delCard(card)">DEL</button></td>
        <td><input type="text" style="width:2em;text-align:right;" v-model.number="card.num"></td>
        <td v-for="col in cols" @click="cardInfoHtml = card.html;">{{ card[col.name] }}</td>
      </tr>
    </table>
    
  </div>
  <div id="card_info_area" style="margin-left:30px">
  
    <h2>カード情報</h3>
    <div v-html="cardInfoHtml"></div>
  
  </div>
</div>


</div>

<script>
Vue.component('save-slot', {
  data     : function() { return {
    SAVE_KEY: "save",
    saveTitle: "",
    selectedSave: null,
    saveList: [], // { title, data }
  }; },
  props: ["value"],
  template : `
    <div>
      <input type="text" v-model="saveTitle">
      <button @click="save()">Save</button>
      <select v-model="selectedSave">
        <option disabled :value="null">select one</option>
        <option v-for="save in saveList" :value="save">{{ save.title }}</option>
      </select>
      <button @click="load()">Load</button>
      <button @click="del()">Delete</button>
    </div>
  `,
  methods: {
    save() {
      if (this.saveTitle == "") { return; }
      
      var save;
      if (this.saveList.filter(i => i.title == this.saveTitle).length == 0) {
        save = {};
        this.saveList.push(save);
      } else {
        save = this.saveList.filter(i => i.title == this.saveTitle)[0];
      }
      save.title = this.saveTitle;
      save.data = JSON.stringify(this.value);
      localStorage.setItem(this.SAVE_KEY, JSON.stringify(this.saveList) );
      
      this.selectedSave = save;
    },
    load() {
      if (this.selectedSave == null) { return; }
      this.saveTitle = this.selectedSave.title;
      this.$emit('input', JSON.parse(this.selectedSave.data));
    },
    del() {
      if (this.selectedSave == null) { return; }
      this.saveList = this.saveList.filter(i => i !== this.selectedSave);
      localStorage.setItem(this.SAVE_KEY, JSON.stringify(this.saveList) );
      this.selectedSave = null;
    },
  },
  mounted() {
    this.saveList = JSON.parse(localStorage.getItem(this.SAVE_KEY)) ?? [];
  },
});

var vue_app = new Vue({
  el: '#vue_app',
  data() { return {
    searchTarget: "",
    progress: null,
    kouhoGrpList: [], // {num, base, list:[kouhoObj, kouhoObj]}
    cols: [
      {name:"name"  , disp:"カード名"  },
      {name:"cost"  , disp:"コスト"    },
      {name:"rarity", disp:"レアリティ"},
      {name:"set"   , disp:"セット"    },
    ],
    currSort: {col:"", asc:true},
    deck: [], // { num, name, cost, rarity, set }
    cardInfoHtml: "",
  }; },
  computed: {
    deckAllNum() {
      return this.deck.reduce((sum, card) => sum + (!isNaN(card.num) ? card.num : 0), 0);
    }
  },
  methods: {
    parseSearchTarget(text) {
      return text.split("\n")
        .filter(line => line.trim() != "")
        .map(line => {
          var matches = line.match(/([0-9]+) +(.*)/);
          return {
            num: matches ? Number(matches[1]) : 0,
            name: matches ? matches[2] : line,
          };
        });
    },
    async search() {
      var searchList = this.parseSearchTarget(this.searchTarget);
      var sleep = (w) => new Promise(resolve => setTimeout(resolve, w));
      
      var progressCnt = 0;
      for (var searchItem of searchList) {
        this.progress = `${progressCnt++} / ${searchList.length}`
        var result = await this.getCard(searchItem.name);
        if (result.type == "detail") {
          // デッキ追加
          this.deck.push({num:searchItem.num, ...result.detail});
        } else {
          // 候補追加
          var kouhoGrp = {num:searchItem.num, base:searchItem.name, list:result.cards};
          this.kouhoGrpList.push(kouhoGrp);
        }
        await sleep(500);
      }
      this.progress = null;
    },
    async getCard(name) {
      var response = await fetch("/get_card?q=" + encodeURIComponent(name));
      return await response.json();
    },
    delKouhoGrp(kouhoGrp) {
      this.kouhoGrpList = this.kouhoGrpList.filter(i => i !== kouhoGrp);
    },
    async selKouho(kouhoGrp, kouho) {
      var result = await this.getCard( kouho.url );
      if (result.type != "detail") {
        alert("err"); console.log(result);
        return;
      }
      this.deck.push({num:kouhoGrp.num, ...result.detail});
      this.delKouhoGrp(kouhoGrp);
    },
    delCard(card) {
      this.deck = this.deck.filter(i => i !== card);
    },
    sort(col) {
      if (col != this.currSort.col) {
        this.currSort = {col, asc:true};
      } else {
        this.currSort.asc = !this.currSort.asc;
      }
      this.deck = this.deck.sort((i1, i2) => this.currSort.asc ? i1[col] > i2[col] : i1[col] < i2[col]);
    },
  },
})
</script>

</body>
</html>
